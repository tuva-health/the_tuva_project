version: 2

models:

## data_visualization
  - name: medical_economics__dim_apr_drg
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_apr_drg
      tags: 
        - apr_drg
      materialized: table
    description: >
      dim apr drg
    columns:
      - name: apr_drg_code
        description: apr drg code
      - name: apr_drg_description
        description: apr drg description

  - name: medical_economics__dim_calendar
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_calendar
      tags: 
        - calendar
      materialized: table
    description: >
      dim calendar
    columns:
      - name: full_date
        description: full date
      - name: year
        description: year
      - name: month
        description: month
      - name: day
        description: day
      - name: month_name
        description: month_name
      - name: day_of_week_number
        description: day_of_week_number
      - name: day_of_week_name
        description: day_of_week_name
      - name: week_of_year
        description: week_of_year
      - name: day_of_year
        description: day_of_year
      - name: year_month
        description: year_month
      - name: first_day_of_month
        description: first_day_of_month
      - name: last_day_of_month
        description: last_day_of_month
      - name: year_month_int
        description: year_month_int

  - name: medical_economics__dim_condition_group
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_condition_group
      tags: 
        - condition_group
      materialized: table
    description: >
      condition grouper reference table
    columns:
      - name: condition_group_1
        description: primary condition group
      - name: condition_group_2
        description: secondary condition group
      - name: condition_group_3
        description: tertiary condition group
      - name: condition_group_id
        description: condition group id
      - name: condition_group_1_simplified
        description: condition group 1 name simplified

  - name: medical_economics__dim_hcpcs
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_hcpcs
      tags: 
        - hcpcs
      materialized: table
    description: >
      hcpcs reference table
    columns:
      - name: hcpcs_code
        description: hcpcs code
      - name: hcpcs_description
        description: hcpcs description

  - name: medical_economics__dim_ms_drg
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_ms_drg
      tags: 
        - ms_drg
      materialized: table
    description: >
      ms drg reference table
    columns:
      - name: ms_drg_code
        description: ms drg code
      - name: ms_drg_description
        description: ms drg description

  - name: medical_economics__dim_patient
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_patient
      tags: 
        - patient
      materialized: table
    description: >
      patient reference table
    columns:
      - name: person_id
        description: person id
      - name: first_name
        description: first name
      - name: last_name
        description: last name
      - name: sex
        description: sex
      - name: race
        description: race
      - name: birth_date
        description: birth date
      - name: death_date
        description: death date
      - name: address
        description: patient address
      - name: city
        description: patient city
      - name: state
        description: patient state
      - name: zip_code
        description: patient zip code
      - name: county
        description: patient county
      - name: latitude
        description: patient latitude
      - name: longitude
        description: patient longitude
      - name: phone
        description: patient phone
      - name: age
        description: age
      - name: age_group
        description: age group

  - name: medical_economics__dim_provider
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_provider
      tags: 
        - provider
      materialized: table
    description: >
      provider reference table
    columns:
      - name: npi
        description: npi
      - name: entity_type_description
        description: individual or orgnaization
      - name: primary_specialty_description
        description: specialty description
      - name: provider_first_name
        description: first name
      - name: provider_last_name
        description: last name
      - name: provider_organization_name
        description: provider_organization_name
      - name: parent_organization_name
        description: parent_organization_name
      - name: practice_address_line_1
        description: practice_address_line_1
      - name: practice_address_line_2
        description: practice_address_line_2
      - name: practice_city
        description: practice_city
      - name: practice_zip_code
        description: practice_zip_code
      - name: mailing_telephone_number
        description: mailing_telephone_number
      - name: location_telephone_number
        description: location_telephone_number
      - name: official_telephone_number
        description: official_telephone_number
      - name: last_updated
        description: last updated in NPPES

  - name: medical_economics__dim_service_category
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_service_category
      tags: 
        - service_category
      materialized: table
    description: >
      service category reference table
    columns:
      - name: service_category_1
        description: service_category_1
      - name: service_category_2
        description: service_category_2
      - name: service_category_3
        description: service_category_3
      - name: service_category_id
        description: service_category_id

  - name: medical_economics__fact_medical_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: fact_medical_claim
      tags: 
        - medical_economics
      materialized: table
    description: >
      fact medical claim table
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - claim_id
            - claim_line_number
    columns:
      - name: person_id
        description: Unique identifier for the patient.
      - name: claim_id
        description: Unique identifier for the claim.
      - name: encounter_id
        description: Unique identifier for the encounter id
      - name: payer
        description: Unique identifier for the payer.
      - name: claim_start_date
        description: claim start date
      - name: claim_end_date
        description: claim end date
      - name: claim_line_number
        description: Line number of the claim.
      - name: service_category_id
        description: service category id
      - name: ms_drg_code
        description: MS DRG code
      - name: apr_drg_code
        description: APR DRG code
      - name: hcpcs_code
        description: All hcpcs codes
      - name: rendering_id
        description: Rendering npi on claim
      - name: paid_amount
        description: Amount paid for the drug.
      - name: allowed_amount
        description: allowed amount for the drug
      - name: condition_grouper_id
        description: condition grouper id
      - name: specialty_provider_id
        description: specialty provider id

  - name: medical_economics__fact_member_months
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: fact_member_months
      tags: 
        - member_months
      materialized: table
    description: >
      Member months table with risk adjustment added
    columns:
      - name: person_id
        description: Unique identifier for each patient
      - name: claim_id
        description: Unique identifier for each pharmacy claim.
      - name: payer
        description: Unique identifier for the payer.
      - name: year_month
        description: year month of YYYYMM format
      - name: member_months
        description: Number of unqiue person_id and payer
      - name: payment_risk_score
        description: >
          The normalized risk score multiplied by the MA coding pattern 
          adjustment factor for the corresponding HCC model version 
          and payment year's rate announcement from CMS.
      - name: risk_adjusted_member_months
        description: >
          Payment risk score multiplied by member_months.

  - name: medical_economics__fact_agg_medical_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: fact_agg_medical_claim
      tags: 
        - medical_economics
      materialized: table
    description: >
      Aggregated fact medical claim table
    columns:
      - name: payer
        description: Unique identifier for the payer.
      - name: year_month
        description: Year month in YYYY-MM-DD format
      - name: service_category_id
        description: service category id
      - name: condition_grouper_id
        description: condition grouper id
      - name: specialty_provider_id
        description: specialty provider id
      - name: paid_amount
        description: Amount paid for the drug
      - name: allowed_amount
        description: allowed amount for the drug
      - name: distinct_claim_id
        description: Distinct claim id 
      - name: distinct_encounter_id
        description: Distinct encounter id

  - name: medical_economics__fact_agg_member_months
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: fact_agg_member_months
      tags: 
        - member_months
      materialized: table
    description: >
      Aggregated member months table with risk adjustment added for better Power BI optimization
    columns:
      - name: payer
        description: Unique identifier for the payer.
      - name: year_month
        description: year month of YYYYMM format
      - name: member_months
        description: Number of unqiue person_id and payer
      - name: risk_adjusted_member_months
        description: >
          Payment risk score multiplied by member_months.

  - name: medical_economics__fact_comparative_population
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: fact_comparative_population
      tags: 
        - dimension
      materialized: table
    description: >
      Fact table containing the two populations of interest for comparison using 
      core.patient as its base with person_id contained.
    columns:
      - name: person_id
        description: Unique person id 
      - name: comparative_population_id
        description: Comparative population id
      - name: comparative_population
        description: Comparative population name

  - name: medical_economics__dim_comparative_population
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: dim_comparative_population
      tags: 
        - dimension
      materialized: table
    description: >
      Dimension table containing the two populations of interest for comparison using 
      core.patient as its base
    columns:
      - name: comparative_population_id
        description: Comparative population id
      - name: comparative_population
        description: Comparative population name

## Final 
  - name: medical_economics__specialty_condition_grouper_pharmacy_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: specialty_condition_grouper_pharmacy_claim
      tags: 
        - pharmacy
      materialized: table
    description: >
      Table that adds condition grouper and specialty grouper to every claim
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - claim_id
            - claim_line_number
    columns:
      - name: person_id
        description: Unique identifier for the patient.
      - name: claim_id
        description: Unique identifier for the claim.
      - name: payer
        description: Unique identifier for the payer.
      - name: claim_line_number
        description: Line number of the claim.
      - name: prescribing_provider_id
        description: Prescribing provider npi
      - name: dispensing_date
        description: Date of dispense
      - name: ndc_code
        description: National Drug Code.
      - name: ndc_description
        description: Description of the drug as per NDC.
      - name: quantity
        description: quantity of prescription
      - name: days_supply
        description: days of supply
      - name: refills
        description: Number of refills left
      - name: paid_amount
        description: Amount paid for the drug.
      - name: allowed_amount
        description: allowed amount for the drug
      - name: condition_grouper_1
        description: Prescribed condition associated with drug
      - name: condition_grouper_2
        description: Prescribed secondary condition associated with drug
      - name: condition_grouper_3
        description: Prescribed tertiary condition associated with drug
      - name: specialty_provider
        description: Specialty of provider prescribing drug, this comes from NPPES

  - name: medical_economics__specialty_condition_grouper_medical_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: specialty_condition_grouper_medical_claim
      tags: 
        - medical_economics
      materialized: table
    description: >
      Table that adds condition grouper and specialty grouper to every claim_line
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - claim_id
            - claim_line_number
    columns:
      - name: person_id
        description: Unique identifier for the patient.
      - name: claim_id
        description: Unique identifier for the claim.
      - name: encounter_id
        description: Unique identifier for the encounter
      - name: payer
        description: Unique identifier for the payer.
      - name: claim_start_date
        description: claim start date
      - name: claim_end_date
        description: claim end date
      - name: claim_line_number
        description: Line number of the claim.
      - name: service_category_1
        description: Primary service category
      - name: service_category_2
        description: Secondary service category
      - name: service_category_3
        description: Tertiary service category
      - name: ms_drg_code
        description: MS DRG code
      - name: apr_drg_code
        description: APR DRG code
      - name: hcpcs_code
        description: All hcpcs codes
      - name: rendering_id
        description: Rendering npi on claim
      - name: paid_amount
        description: Amount paid for the drug.
      - name: allowed_amount
        description: allowed amount for the drug
      - name: condition_grouper_1
        description: Prescribed condition associated with drug
      - name: condition_grouper_2
        description: Prescribed secondary condition associated with drug
      - name: condition_grouper_3
        description: Prescribed tertiary condition associated with drug
      - name: specialty_provider
        description: Specialty of provider prescribing drug, this comes from NPPES

  - name: medical_economics__risk_adjusted_member_months
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: risk_adjusted_member_months
      tags: 
        - member_months
      materialized: table
    description: >
      Member months table with risk adjustment added
    columns:
      - name: person_id
        description: Unique identifier for each patient
      - name: claim_id
        description: Unique identifier for each pharmacy claim.
      - name: payer
        description: Unique identifier for the payer.
      - name: year_month
        description: year month of YYYYMM format
      - name: member_months
        description: Number of unqiue person_id and payer
      - name: payment_risk_score
        description: >
          The normalized risk score multiplied by the MA coding pattern 
          adjustment factor for the corresponding HCC model version 
          and payment year's rate announcement from CMS.
      - name: risk_adjusted_member_months
        description: >
          Payment risk score multiplied by member_months.

  - name: medical_economics__high_cost_claimant
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: high_cost_claimant
      tags: 
        - member_months
      materialized: table
    description: >
      Identifies all patients who have had over 150k in spend over the past 12 months. If a patient 
      has less than 12 months of paid claims but still in total has more than 150k in spend over that
      period the flag will start once they have hit over 150k spend.
    columns:
      - name: person_id
        description: Unique identifier for each patient
      - name: payer
        description: Unique identifier for the payer.
      - name: year_month
        description: year month of YYYYMM format
      - name: total_paid
        description: Total paid_amount for the particular year_month and payer
      - name: rolling_12_paid_amount
        description: >
          Sums all paid amounts for the past 12 months 
      - name: high_cost_claimant_flag
        description: >
          Flag representing all patient with over 150k paid in claims over the past 
          12 months

## Intermediate
  - name: medical_economics__specialty_pharmacy_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: _specialty_pharmacy_claim
      tags: 
        - pharmacy
      materialized: view
    description: >
      Intermediate view identifying all pharmacy claims with a specialty

  - name: medical_economics__condition_grouper_pharmacy_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: _condition_grouper_pharmacy_claim
      tags: 
        - pharmacy
      materialized: view
    description: >
      Intermediate view identifying all pharmacy claims with a condition

  - name: medical_economics__specialty_medical_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: _specialty_medical_claim
      tags: 
        - pharmacy
      materialized: view
    description: >
      Intermediate view identifying all medical claims with a specialty

  - name: medical_economics__condition_grouper_medical_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_medical_economics
        {%- else -%}
          medical_economics
        {%- endif -%}
      alias: _condition_grouper_medical_claim
      tags: 
        - pharmacy
      materialized: view
    description: >
      Intermediate view identifying all medical claims with a condition

## Stage

  - name: medical_economics__stg_core_medical_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_medical_economics{% else %}medical_economics{%- endif -%}
      alias: _stg_core_medical_claim
      tags: medical_economics
      materialized: ephemeral
    description: >
      Staging medical claims from the core layer. Creates an empty table if 
      using clinical only.
    columns:
      - name: person_id
      - name: claim_id
      - name: encounter_id
      - name: payer
      - name: claim_start_date
      - name: claim_end_date
      - name: service_category_1
      - name: service_category_2
      - name: service_category_3
      - name: ms_drg_code
      - name: apr_drg_code
      - name: hcpcs_code
      - name: rendering_id
      - name: paid_amount
      - name: allowed_amount

  - name: medical_economics__stg_core_pharmacy_claim
    config:
      schema: |
                {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_medical_economics{% else %}medical_economics{%- endif -%}
      alias: _stg_core_pharmacy_claim
      tags: medical_economics
      materialized: ephemeral
    description: >
      Staging pharmacy claims from the core layer. Creates an empty table if 
      using clinical only.
    columns:
      - name: person_id
      - name: claim_id 
      - name: payer 
      - name: claim_line_number
      - name: prescribing_provider_id
      - name: dispensing_date
      - name: ndc_code
      - name: ndc_description
      - name: quantity
      - name: days_supply
      - name: refills
      - name: paid_amount
      - name: allowed_amount

  - name: medical_economics__stg_core_member_months
    config:
      schema: |
                {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_medical_economics{% else %}medical_economics{%- endif -%}
      alias: _stg_core_member_months
      tags: medical_economics
      materialized: ephemeral
    description: >
      Staging member months from the core layer
    columns:
      - name: person_id
      - name: year_month 
      - name: payer 
      - name: member_month

  - name: medical_economics__stg_ccsr_long_condition_category
    config:
      schema: |
                {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_medical_economics{% else %}medical_economics{%- endif -%}
      alias: _stg_ccsr_long_condition_category
      tags: medical_economics
      materialized: ephemeral
    description: >
      Staging ccsr long condition category
    columns:
      - name: person_id
      - name: claim_id 
      - name: condition_grouper_1 
      - name: condition_grouper_2
      - name: condition_grouper_3

  - name: medical_economics__stg_cms_hcc_patient_risk_scores
    config:
      schema: |
                {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_medical_economics{% else %}medical_economics{%- endif -%}
      alias: _stg_cms_hcc_patient_risk_scores
      tags: medical_economics
      materialized: ephemeral
    description: >
      Staging cms hcc patient risk score category
    columns:
      - name: person_id
      - name: payment_year  
      - name: payment_risk_score 

  - name: medical_economics__stg_terminology_provider
    config:
      schema: |
                {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_medical_economics{% else %}medical_economics{%- endif -%}
      alias: _stg_terminology_provider
      tags: medical_economics
      materialized: ephemeral
    description: >
      Staging terminology provider, adding specialty from crosswalk created for mainstem
    columns:
      - name: npi 
      - name: entity_type_description
      - name: primary_taxonomy_code
      - name: primary_specialty_description
      - name: provider_first_name
      - name: provider_last_name
      - name: provider_organization_name
      - name: parent_organization_name
      - name: specialty
